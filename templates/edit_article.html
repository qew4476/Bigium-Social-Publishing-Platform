{% extends 'base.html' %}
{% block title %}Edit Article{% endblock %}
{% block body %}
<head>
    <link rel="stylesheet" href="{% static 'css/markdown.css' %}">
    <link rel="stylesheet" href="{% static 'css/article_base.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
</head>
<main class="container bg-white p-3 rounded">
    <h1>Edit Article</h1>
    <form method="POST">
        {% csrf_token %}
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ article.title }}" required>
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">Content (Markdown)</label>
            <textarea class="form-control" id="content" name="content" rows="10" required oninput="updatePreview()">{{ article.content }}</textarea>
        </div>

        <div class="mb-3">
            <label for="tags" class="form-label">Tags</label>
            <select id="tags" name="tags" class="form-select" multiple onchange="updateSelectedTags()">
                {% for tag in tags %}
                    <option value="{{ tag.id }}" {% if tag in article.tags.all %}selected{% endif %}>{{ tag.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- 顯示已選擇的標籤 -->
        <div class="mb-3">
            <label for="selected-tags" class="form-label">Selected Tags</label>
            <div id="selected-tags" class="d-flex flex-wrap">
                {% for tag in article.tags.all %}
                    <span class="badge bg-secondary me-2 mb-2" data-tag-id="{{ tag.id }}">{{ tag.name }} <button type="button" class="btn-close btn-sm" onclick="removeTag({{ tag.id }})"></button></span>
                {% endfor %}
            </div>
        </div>

        <div id="markdown-preview" class="mt-3 border p-3 rounded bg-light" style="min-height: 200px;"></div>

        <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>
</main>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        updatePreview();
    });

    function updatePreview() {
        const markdownContent = document.getElementById("content").value;
        const preview = document.getElementById("markdown-preview");
        preview.innerHTML = marked.parse(markdownContent);
    }

    // 更新已選擇的標籤顯示
    function updateSelectedTags() {
        const selectedTags = Array.from(document.getElementById("tags").selectedOptions);
        const selectedTagsContainer = document.getElementById("selected-tags");
        selectedTagsContainer.innerHTML = "";  // 清空現有標籤

        selectedTags.forEach(option => {
            const tagName = option.text;
            const tagId = option.value;

            const tagElement = document.createElement("span");
            tagElement.classList.add("badge", "bg-secondary", "me-2", "mb-2");
            tagElement.setAttribute("data-tag-id", tagId);
            tagElement.innerHTML = `${tagName} <button type="button" class="btn-close btn-sm" onclick="removeTag(${tagId})"></button>`;
            selectedTagsContainer.appendChild(tagElement);
        });
    }

    // 移除已選擇的標籤
    function removeTag(tagId) {
        const tagElement = document.querySelector(`span[data-tag-id="${tagId}"]`);
        if (tagElement) {
            tagElement.remove();
            // 也需要從下拉選單中移除選中狀態
            const selectElement = document.getElementById("tags");
            const optionElement = selectElement.querySelector(`option[value="${tagId}"]`);
            if (optionElement) {
                optionElement.selected = false;
            }
        }
    }
</script>
{% endblock %}
